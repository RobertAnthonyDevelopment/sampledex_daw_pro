name: Deterministic macOS Build

on:
  workflow_dispatch:

jobs:
  build_macos:
    name: Build macOS App
    runs-on: macos-latest

    env:
      JUCE_VERSION: 8.0.10
      JUCE_DIR: ${{ github.workspace }}/JUCE
      CANONICAL_APP_PATH: ${{ github.workspace }}/build/SampledexChordLab_artefacts/Release/Sampledex ChordLab.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install JUCE
        run: |
          git clone --depth 1 --branch "${JUCE_VERSION}" https://github.com/juce-framework/JUCE.git "${JUCE_DIR}"

      - name: Run deterministic release build
        run: |
          chmod +x ./scripts/release_macos.sh
          ./scripts/release_macos.sh

      - name: Package canonical app bundle
        run: |
          APP_PATH="${CANONICAL_APP_PATH}"
          ZIP_PATH="${{ github.workspace }}/build/SampledexChordLab_artefacts/Release/SampledexChordLab_Mac.zip"
          if [[ ! -d "${APP_PATH}" ]]; then
            echo "Canonical app not found at ${APP_PATH}" >&2
            exit 1
          fi
          /usr/bin/ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${ZIP_PATH}"
          echo "ZIP_PATH=${ZIP_PATH}" >> "${GITHUB_ENV}"

      - name: Upload macOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: SampledexChordLab-macOS
          path: |
            ${{ env.ZIP_PATH }}
            ${{ env.CANONICAL_APP_PATH }}/Contents/Resources/BuildManifest.json
