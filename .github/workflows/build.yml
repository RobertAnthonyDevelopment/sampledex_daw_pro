name: Deterministic macOS Build

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build_macos:
    name: Build macOS App
    runs-on: macos-latest

    env:
      JUCE_VERSION: 8.0.10
      JUCE_DIR: ${{ github.workspace }}/JUCE

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install JUCE
        run: |
          git clone --depth 1 --branch "${JUCE_VERSION}" https://github.com/juce-framework/JUCE.git "${JUCE_DIR}"

      - name: Run deterministic release build
        run: |
          chmod +x ./scripts/release_macos.sh
          ./scripts/release_macos.sh

      - name: Package canonical app bundle
        run: |
          APP_PATH="$(find "${{ github.workspace }}/build" -type d -name "Sampledex ChordLab.app" -print -quit)"
          ZIP_PATH="${{ github.workspace }}/build/SampledexChordLab_artefacts/Release/SampledexChordLab_Mac.zip"
          if [[ -z "${APP_PATH}" || ! -d "${APP_PATH}" ]]; then
            echo "Canonical app not found under build output" >&2
            exit 1
          fi
          /usr/bin/ditto -c -k --sequesterRsrc --keepParent "${APP_PATH}" "${ZIP_PATH}"
          echo "CANONICAL_APP_PATH=${APP_PATH}" >> "${GITHUB_ENV}"
          echo "ZIP_PATH=${ZIP_PATH}" >> "${GITHUB_ENV}"

      - name: Upload macOS app artifact
        uses: actions/upload-artifact@v4
        with:
          name: SampledexChordLab-macOS
          path: |
            ${{ env.ZIP_PATH }}
            ${{ env.CANONICAL_APP_PATH }}/Contents/Resources/BuildManifest.json
